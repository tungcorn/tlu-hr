// =============================================================================
// HRMS Database Schema - Domain-Driven Design (DDD) Version
// Truong Dai hoc Thuy loi (TLU) - Human Resource Management System
// =============================================================================
// Version: 2.0 (DDD Refactored)
// Date: 2026-01-23
// =============================================================================
// 
// DDD STRUCTURE:
// 
// ┌─────────────────────────────────────────────────────────────────────────────┐
// │                           BOUNDED CONTEXTS                                  │
// ├─────────────────────────────────────────────────────────────────────────────┤
// │  1. PERSONNEL (Core Domain)           - Employee identity & qualifications │
// │  2. ORGANIZATION (Core Domain)        - Org structure & assignments        │
// │  3. EMPLOYMENT (Core Domain)          - Contracts & work relationships     │
// │  4. COMPENSATION (Core Domain)        - Payroll, salary, benefits          │
// │  5. TIME_MANAGEMENT (Supporting)      - Attendance, leave, overtime        │
// │  6. RECRUITMENT (Supporting)          - Hiring process                     │
// │  7. PERFORMANCE (Supporting)          - Evaluation, rewards, discipline    │
// │  8. DEVELOPMENT (Supporting)          - Training & career development      │
// │  9. ACADEMIC (Supporting - Univ)      - Research & teaching load           │
// │ 10. CONFIGURATION (Generic Subdomain) - System parameters                  │
// │ 11. IDENTITY (Generic Subdomain)      - Auth & authorization               │
// │ 12. SHARED_KERNEL                     - Cross-context shared concepts      │
// └─────────────────────────────────────────────────────────────────────────────┘
//
// LEGEND:
// - [AR] = Aggregate Root
// - [E]  = Entity (within aggregate)
// - [VO] = Value Object (embedded or separate table for normalization)
// - [DE] = Domain Event (for audit/history)
//
// =============================================================================

Project HRMS_TLU_DDD {
  database_type: 'PostgreSQL'
  Note: '''
    # HRMS - Domain-Driven Design Schema
    
    ## Bounded Contexts:
    - personnel_* : Personnel Management (Core)
    - org_* : Organization Management (Core)  
    - employment_* : Employment/Contract (Core)
    - compensation_* : Payroll & Benefits (Core)
    - time_* : Time & Attendance (Supporting)
    - recruit_* : Recruitment (Supporting)
    - perf_* : Performance Management (Supporting)
    - dev_* : Training & Development (Supporting)
    - academic_* : Research & Teaching (Supporting)
    - config_* : System Configuration (Generic)
    - identity_* : Identity & Access (Generic)
    - shared_* : Shared Kernel
  '''
}

// =============================================================================
// SHARED KERNEL
// Cross-cutting concepts used by multiple bounded contexts
// =============================================================================

TableGroup shared_kernel {
  shared_audit_log
  shared_document
  shared_notification
  shared_address
}

// [VO] Address - Value Object used across contexts
Table shared_address {
  id uuid [pk, note: 'Surrogate key for FK references']
  street varchar(500)
  ward varchar(100) [note: 'Phuong/Xa']
  district varchar(100) [note: 'Quan/Huyen']
  city varchar(100) [note: 'Tinh/Thanh pho']
  country varchar(100) [default: 'Viet Nam']
  postal_code varchar(20)
  
  Note: '[VO] Reusable address value object'
}

// [DE] Domain Event Log - Captures all domain events
Table shared_audit_log {
  id uuid [pk, default: `gen_random_uuid()`]
  aggregate_type varchar(100) [not null, note: 'e.g., Employee, Contract, Payroll']
  aggregate_id uuid [not null]
  event_type varchar(100) [not null, note: 'e.g., EmployeeHired, ContractSigned']
  event_data jsonb [not null, note: 'Event payload']
  occurred_at timestamp [not null, default: `now()`]
  caused_by_user_id uuid
  correlation_id uuid [note: 'For tracking related events']
  
  indexes {
    (aggregate_type, aggregate_id)
    occurred_at
  }
  
  Note: '[DE] Domain event store for event sourcing/audit'
}

// Shared document storage
Table shared_document {
  id uuid [pk, default: `gen_random_uuid()`]
  owner_type varchar(100) [not null, note: 'Employee, Contract, Research...']
  owner_id uuid [not null]
  document_type varchar(50) [not null]
  file_name varchar(255) [not null]
  file_path varchar(500) [not null]
  file_size int
  mime_type varchar(100)
  uploaded_at timestamp [default: `now()`]
  uploaded_by uuid
  
  Note: 'Shared document storage'
}

// Cross-context notifications
Table shared_notification {
  id uuid [pk, default: `gen_random_uuid()`]
  recipient_id uuid [not null]
  title varchar(200) [not null]
  content text
  link varchar(500)
  source_context varchar(50) [note: 'Which bounded context sent this']
  source_aggregate_id uuid
  is_read boolean [default: false]
  created_at timestamp [default: `now()`]
  
  Note: 'Cross-context notification system'
}

// =============================================================================
// BOUNDED CONTEXT: CONFIGURATION (Generic Subdomain)
// System parameters that can be changed without code changes
// =============================================================================

TableGroup configuration_context {
  config_parameter
  config_salary_scale
  config_salary_grade
  config_allowance_policy
  config_insurance_policy
  config_tax_policy
  config_leave_policy
  config_contract_policy
  config_teaching_policy
}

// [AR] Configuration Parameter - Generic key-value config
Table config_parameter {
  id uuid [pk, default: `gen_random_uuid()`]
  category varchar(50) [not null, note: 'salary, leave, contract, teaching...']
  param_key varchar(100) [not null]
  param_value text [not null]
  value_type varchar(20) [not null, note: 'string, number, boolean, json']
  effective_from date [not null]
  effective_to date
  description text
  legal_reference varchar(200) [note: 'Reference to legal document']
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  created_by uuid
  
  indexes {
    (category, param_key, effective_from) [unique]
  }
  
  Note: '[AR] Generic configuration parameter with temporal validity'
}

// [AR] Salary Scale - Ngach luong
Table config_salary_scale {
  id uuid [pk, default: `gen_random_uuid()`]
  code varchar(20) [not null, unique, note: 'V.07.01.01, V.07.01.02...']
  name varchar(100) [not null, note: 'Giang vien cao cap, GV chinh, GV']
  scale_group varchar(50) [note: 'lecturer, specialist, service']
  min_grade int [default: 1]
  max_grade int [not null]
  effective_from date [not null]
  effective_to date
  is_active boolean [default: true]
  
  Note: '[AR] Salary scale/rank definition (Ngach luong)'
}

// [E] Salary Grade - Bac luong (belongs to Scale aggregate)
Table config_salary_grade {
  id uuid [pk, default: `gen_random_uuid()`]
  scale_id uuid [ref: > config_salary_scale.id, not null]
  grade_number int [not null, note: 'Bac 1, 2, 3...']
  coefficient decimal(4,2) [not null, note: 'He so luong']
  years_to_next int [note: 'So nam de len bac tiep theo']
  effective_from date [not null]
  effective_to date
  
  indexes {
    (scale_id, grade_number, effective_from) [unique]
  }
  
  Note: '[E] Salary grade within a scale (Bac luong)'
}

// [AR] Allowance Policy - Chinh sach phu cap
Table config_allowance_policy {
  id uuid [pk, default: `gen_random_uuid()`]
  code varchar(20) [not null, unique]
  name varchar(100) [not null]
  calculation_type varchar(30) [not null, note: 'coefficient, percentage, fixed']
  calculation_base varchar(50) [note: 'base_salary, gross_salary, fixed']
  default_value decimal(10,4) [note: 'He so or ty le or so tien']
  is_taxable boolean [default: true]
  effective_from date [not null]
  effective_to date
  legal_reference varchar(200)
  
  Note: '[AR] Allowance type and calculation policy'
}

// [AR] Insurance Policy - Chinh sach bao hiem
Table config_insurance_policy {
  id uuid [pk, default: `gen_random_uuid()`]
  insurance_type varchar(20) [not null, note: 'BHXH, BHYT, BHTN']
  employee_rate decimal(5,2) [not null]
  employer_rate decimal(5,2) [not null]
  salary_ceiling decimal(15,2) [note: 'Muc tran tinh dong']
  effective_from date [not null]
  effective_to date
  legal_reference varchar(200)
  
  indexes {
    (insurance_type, effective_from) [unique]
  }
  
  Note: '[AR] Insurance contribution rates'
}

// [AR] Tax Policy - Chinh sach thue TNCN
Table config_tax_policy {
  id uuid [pk, default: `gen_random_uuid()`]
  policy_name varchar(100) [not null]
  personal_deduction decimal(15,2) [not null, note: 'Giam tru ban than']
  dependent_deduction decimal(15,2) [not null, note: 'Giam tru nguoi phu thuoc']
  effective_from date [not null]
  effective_to date
  
  Note: '[AR] Personal income tax policy'
}

// [E] Tax Bracket - Bac thue (belongs to Tax Policy)
Table config_tax_bracket {
  id uuid [pk, default: `gen_random_uuid()`]
  policy_id uuid [ref: > config_tax_policy.id, not null]
  bracket_order int [not null]
  min_income decimal(15,2) [not null]
  max_income decimal(15,2)
  tax_rate decimal(5,2) [not null]
  
  indexes {
    (policy_id, bracket_order) [unique]
  }
  
  Note: '[E] Progressive tax bracket'
}

// [AR] Leave Policy - Chinh sach nghi phep
Table config_leave_policy {
  id uuid [pk, default: `gen_random_uuid()`]
  leave_type_code varchar(20) [not null]
  leave_type_name varchar(100) [not null]
  base_days_per_year int
  seniority_bonus_days int [note: 'Ngay cong them theo tham nien']
  seniority_period_years int [note: 'Moi X nam']
  is_paid boolean [default: true]
  requires_approval boolean [default: true]
  max_consecutive_days int
  effective_from date [not null]
  effective_to date
  
  Note: '[AR] Leave type and entitlement policy'
}

// [AR] Contract Policy - Chinh sach hop dong
Table config_contract_policy {
  id uuid [pk, default: `gen_random_uuid()`]
  contract_type_code varchar(20) [not null]
  contract_type_name varchar(100) [not null]
  min_duration_months int
  max_duration_months int
  max_consecutive_contracts int
  probation_days int
  is_indefinite boolean [default: false]
  auto_convert_to varchar(20) [note: 'Contract type to convert to']
  effective_from date [not null]
  effective_to date
  
  Note: '[AR] Contract type and rules policy'
}

// [AR] Teaching Policy - Chinh sach gio giang
Table config_teaching_policy {
  id uuid [pk, default: `gen_random_uuid()`]
  applicable_to varchar(50) [not null, note: 'Scale code or academic title']
  standard_hours_per_year int [not null]
  theory_conversion_rate decimal(4,2) [default: 1.0]
  practice_conversion_rate decimal(4,2) [default: 0.5]
  thesis_supervision_hours int
  overtime_rate_per_hour decimal(15,2)
  effective_from date [not null]
  effective_to date
  
  Note: '[AR] Teaching load quota and conversion rates'
}

// =============================================================================
// BOUNDED CONTEXT: ORGANIZATION (Core Domain)
// Organizational structure, units, campuses
// =============================================================================

TableGroup organization_context {
  org_campus
  org_unit
  org_unit_relationship
  org_unit_event
  org_laboratory
}

// [AR] Campus - Co so
Table org_campus {
  id uuid [pk, default: `gen_random_uuid()`]
  code varchar(20) [not null, unique]
  name varchar(200) [not null]
  name_en varchar(200)
  address_id uuid [ref: > shared_address.id]
  phone varchar(50)
  email varchar(100)
  is_main_campus boolean [default: false]
  established_date date
  status varchar(20) [default: 'active']
  
  // Aggregate metadata
  version int [default: 1]
  created_at timestamp [default: `now()`]
  updated_at timestamp
  
  Note: '[AR] Campus/Branch - aggregate root for location'
}

// [AR] Organization Unit - Don vi to chuc
Table org_unit {
  id uuid [pk, default: `gen_random_uuid()`]
  code varchar(20) [not null, unique]
  name varchar(200) [not null]
  name_en varchar(200)
  
  // Unit classification
  unit_type varchar(30) [not null, note: 'faculty, department, institute, center, office, lab']
  unit_level int [not null, note: '1=school, 2=faculty, 3=department, 4=lab']
  
  // Hierarchy
  parent_unit_id uuid [ref: > org_unit.id]
  campus_id uuid [ref: > org_campus.id]
  
  // Contact info (Value Objects embedded)
  office_address text
  phone varchar(50)
  email varchar(100)
  website varchar(200)
  
  // Lifecycle
  established_date date
  dissolved_date date
  status varchar(20) [default: 'active', note: 'active, merged, dissolved']
  
  // Aggregate metadata
  version int [default: 1]
  created_at timestamp [default: `now()`]
  updated_at timestamp
  
  Note: '[AR] Organization Unit - aggregate root for org structure'
}

// [E] Unit Relationship - Quan he don vi (parallel units like Khoa-Vien)
Table org_unit_relationship {
  id uuid [pk, default: `gen_random_uuid()`]
  unit_id uuid [ref: > org_unit.id, not null]
  related_unit_id uuid [ref: > org_unit.id, not null]
  relationship_type varchar(30) [not null, note: 'parallel, successor, predecessor']
  effective_from date [not null]
  effective_to date
  description text
  
  Note: '[E] Relationship between units (e.g., Faculty-Institute parallel)'
}

// [DE] Unit Event - Su kien don vi
Table org_unit_event {
  id uuid [pk, default: `gen_random_uuid()`]
  unit_id uuid [ref: > org_unit.id, not null]
  event_type varchar(50) [not null, note: 'established, renamed, merged, split, dissolved']
  event_date date [not null]
  description text
  related_unit_ids uuid[] [note: 'For merge/split events']
  recorded_at timestamp [default: `now()`]
  recorded_by uuid
  
  Note: '[DE] Domain event for unit lifecycle changes'
}

// [E] Laboratory - Phong thi nghiem (belongs to Unit)
Table org_laboratory {
  id uuid [pk, default: `gen_random_uuid()`]
  unit_id uuid [ref: > org_unit.id, not null]
  code varchar(20) [not null]
  name varchar(200) [not null]
  location text
  equipment_summary text
  status varchar(20) [default: 'active']
  
  Note: '[E] Laboratory within an organization unit'
}

// =============================================================================
// BOUNDED CONTEXT: PERSONNEL (Core Domain)
// Employee identity, personal info, qualifications
// =============================================================================

TableGroup personnel_context {
  personnel_employee
  personnel_employee_snapshot
  personnel_family_member
  personnel_degree
  personnel_certificate
  personnel_academic_title
  personnel_teacher_honor
  personnel_work_history
}

// [AR] Employee - Nhan vien (Aggregate Root)
Table personnel_employee {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_code varchar(20) [not null, unique]
  
  // Identity (Value Objects - could be separate tables but embedded for simplicity)
  first_name varchar(50) [not null]
  last_name varchar(50) [not null]
  full_name varchar(100) [not null]
  date_of_birth date [not null]
  gender varchar(10) [not null]
  
  // National ID (Value Object)
  national_id_number varchar(20) [unique]
  national_id_issue_date date
  national_id_issue_place varchar(200)
  
  // Origin info
  place_of_birth varchar(200)
  hometown varchar(200)
  ethnicity varchar(50)
  religion varchar(50)
  nationality varchar(50) [default: 'Viet Nam']
  
  // Contact (Value Object)
  personal_email varchar(100)
  work_email varchar(100)
  phone varchar(20)
  permanent_address_id uuid [ref: > shared_address.id]
  temporary_address_id uuid [ref: > shared_address.id]
  
  // Bank Account (Value Object)
  bank_name varchar(100)
  bank_account_number varchar(50)
  bank_branch varchar(200)
  
  // Party/Union membership
  is_party_member boolean [default: false]
  party_join_date date
  party_official_date date
  party_cell varchar(200)
  is_union_member boolean [default: false]
  
  // For lecturers
  research_areas text
  research_keywords text
  profile_url varchar(500)
  
  // For visiting lecturers
  primary_workplace varchar(200)
  employee_type varchar(30) [not null, note: 'full_time, part_time, visiting, contract']
  
  // Photos (Value Object)
  photo_3x4_url varchar(500)
  photo_4x6_url varchar(500)
  
  // Lifecycle
  hire_date date [not null]
  termination_date date
  status varchar(20) [default: 'active', note: 'active, on_leave, terminated, retired']
  
  // Aggregate metadata
  version int [default: 1]
  created_at timestamp [default: `now()`]
  updated_at timestamp
  
  Note: '[AR] Employee - Core aggregate root for personnel identity'
}

// [DE] Employee Snapshot - Luu tru trang thai nhan vien theo thoi gian
Table personnel_employee_snapshot {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [ref: > personnel_employee.id, not null]
  snapshot_date date [not null]
  snapshot_data jsonb [not null, note: 'Full employee state at point in time']
  reason varchar(100) [note: 'annual_report, audit, contract_change']
  created_at timestamp [default: `now()`]
  
  Note: '[DE] Point-in-time snapshot of employee for historical queries'
}

// [E] Family Member - Thanh vien gia dinh
Table personnel_family_member {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [ref: > personnel_employee.id, not null]
  relationship varchar(30) [not null, note: 'spouse, child, parent, sibling']
  full_name varchar(100) [not null]
  date_of_birth date
  occupation varchar(100)
  workplace varchar(200)
  national_id_number varchar(20)
  
  // For tax dependent
  is_tax_dependent boolean [default: false]
  tax_dependent_from date
  tax_dependent_to date
  tax_code varchar(20)
  
  Note: '[E] Family member within Employee aggregate'
}

// [E] Degree - Bang cap
Table personnel_degree {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [ref: > personnel_employee.id, not null]
  
  // Degree info (Value Object properties)
  degree_level varchar(30) [not null, note: 'bachelor, master, doctorate, postdoc']
  degree_name varchar(200) [not null]
  major varchar(200) [not null]
  
  // Institution (could reference a shared institution table)
  institution_name varchar(200) [not null]
  institution_country varchar(100) [default: 'Viet Nam']
  is_domestic boolean [default: true]
  
  graduation_year int
  graduation_date date
  classification varchar(50) [note: 'excellent, good, average']
  certificate_number varchar(100)
  is_highest_degree boolean [default: false]
  
  verified_at timestamp
  verified_by uuid
  
  Note: '[E] Academic degree within Employee aggregate'
}

// [E] Certificate - Chung chi
Table personnel_certificate {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [ref: > personnel_employee.id, not null]
  
  certificate_type varchar(30) [not null, note: 'language, it, pedagogy, professional']
  certificate_name varchar(200) [not null]
  issuing_organization varchar(200)
  issue_date date
  expiry_date date
  score varchar(50) [note: 'IELTS 7.5, TOEFL 100']
  certificate_number varchar(100)
  
  // Alert for expiring certificates
  expiry_alert_sent boolean [default: false]
  
  Note: '[E] Professional certificate within Employee aggregate'
}

// [E] Academic Title - Hoc ham (GS, PGS)
Table personnel_academic_title {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [ref: > personnel_employee.id, not null]
  
  title_type varchar(20) [not null, note: 'professor, associate_professor']
  conferment_year int [not null]
  conferment_date date
  decision_number varchar(100)
  is_current boolean [default: true]
  
  Note: '[E] Academic title (Professor rank) within Employee aggregate'
}

// [E] Teacher Honor - Danh hieu nha giao (NGUT, NGND)
Table personnel_teacher_honor {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [ref: > personnel_employee.id, not null]
  
  honor_type varchar(30) [not null, note: 'meritorious_teacher, peoples_teacher']
  conferment_year int [not null]
  decision_number varchar(100)
  
  Note: '[E] Teacher honor title within Employee aggregate'
}

// [E] Work History - Qua trinh cong tac (before joining TLU)
Table personnel_work_history {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [ref: > personnel_employee.id, not null]
  
  organization_name varchar(200) [not null]
  position varchar(100)
  start_date date [not null]
  end_date date
  responsibilities text
  is_pre_tlu boolean [default: true, note: 'Before joining TLU']
  
  Note: '[E] Work history record within Employee aggregate'
}

// =============================================================================
// BOUNDED CONTEXT: EMPLOYMENT (Core Domain)
// Contracts, assignments, positions
// =============================================================================

TableGroup employment_context {
  employment_contract
  employment_contract_appendix
  employment_contract_termination
  employment_assignment
  employment_position_appointment
  employment_work_permit
}

// [AR] Contract - Hop dong lao dong
Table employment_contract {
  id uuid [pk, default: `gen_random_uuid()`]
  contract_number varchar(50) [not null, unique]
  employee_id uuid [not null, note: 'Reference to Personnel context']
  
  // Contract type (from config)
  contract_type_code varchar(20) [not null]
  
  // Dates
  signing_date date [not null]
  effective_date date [not null]
  expiry_date date [note: 'null = indefinite']
  
  // Job info
  job_title varchar(200)
  job_description text
  work_location varchar(200)
  
  // Salary info at contract time
  salary_scale_code varchar(20)
  salary_grade int
  salary_coefficient decimal(4,2)
  
  // Probation
  probation_end_date date
  probation_passed boolean
  probation_passed_date date
  
  // Contract chain
  previous_contract_id uuid [ref: > employment_contract.id]
  renewal_sequence int [default: 1]
  
  // Status
  status varchar(20) [default: 'active', note: 'draft, active, expired, terminated, superseded']
  
  // Aggregate metadata
  version int [default: 1]
  created_at timestamp [default: `now()`]
  created_by uuid
  
  Note: '[AR] Employment Contract - aggregate root'
}

// [E] Contract Appendix - Phu luc hop dong
Table employment_contract_appendix {
  id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [ref: > employment_contract.id, not null]
  appendix_number varchar(50) [not null]
  signing_date date [not null]
  effective_date date [not null]
  
  // Changes
  change_type varchar(50) [not null, note: 'salary, position, location, other']
  change_description text
  new_salary_scale_code varchar(20)
  new_salary_grade int
  new_job_title varchar(200)
  
  created_at timestamp [default: `now()`]
  created_by uuid
  
  Note: '[E] Contract appendix within Contract aggregate'
}

// [E] Contract Termination - Cham dut hop dong
Table employment_contract_termination {
  id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [ref: > employment_contract.id, not null, unique]
  
  termination_date date [not null]
  termination_type varchar(30) [not null, note: 'resignation, dismissal, retirement, expiry, mutual']
  reason text
  
  // Payments
  severance_pay decimal(15,2)
  remaining_leave_pay decimal(15,2)
  other_payments decimal(15,2)
  
  decision_number varchar(100)
  decision_date date
  
  created_at timestamp [default: `now()`]
  created_by uuid
  
  Note: '[E] Contract termination within Contract aggregate'
}

// [AR] Assignment - Phan cong don vi
Table employment_assignment {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  unit_id uuid [not null, note: 'Reference to Organization context']
  
  assignment_type varchar(20) [not null, note: 'primary, concurrent, secondment']
  start_date date [not null]
  end_date date
  
  decision_number varchar(100)
  decision_date date
  
  is_current boolean [default: true]
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  indexes {
    (employee_id, unit_id, assignment_type, start_date) [unique]
  }
  
  Note: '[AR] Unit assignment - links employee to organization'
}

// [AR] Position Appointment - Bo nhiem chuc vu
Table employment_position_appointment {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  unit_id uuid [not null]
  
  // Position info
  position_code varchar(30) [not null, note: 'rector, vice_rector, dean, head_of_dept...']
  position_name varchar(100) [not null]
  
  appointment_type varchar(20) [not null, note: 'appointment, acting, dismissal']
  effective_date date [not null]
  end_date date
  
  decision_number varchar(100)
  decision_date date
  
  is_current boolean [default: true]
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Position/role appointment'
}

// [E] Work Permit - Giay phep lao dong (for foreigners)
Table employment_work_permit {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  permit_number varchar(100) [not null]
  issue_date date [not null]
  expiry_date date [not null]
  issuing_authority varchar(200)
  job_position varchar(200)
  work_location varchar(200)
  
  Note: '[E] Work permit for foreign employees'
}

// =============================================================================
// BOUNDED CONTEXT: COMPENSATION (Core Domain)
// Payroll, salary, allowances, deductions
// =============================================================================

TableGroup compensation_context {
  compensation_salary_record
  compensation_allowance_assignment
  compensation_payroll_period
  compensation_payslip
  compensation_payslip_item
  compensation_advance
  compensation_bonus
}

// [AR] Salary Record - Bac luong hien tai
Table compensation_salary_record {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  salary_scale_code varchar(20) [not null]
  salary_grade int [not null]
  salary_coefficient decimal(4,2) [not null]
  
  effective_date date [not null]
  end_date date
  
  promotion_type varchar(30) [note: 'regular, early, appointment']
  decision_number varchar(100)
  decision_date date
  
  is_current boolean [default: true]
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Current salary grade record'
}

// [E] Allowance Assignment - Phan bo phu cap
Table compensation_allowance_assignment {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  allowance_policy_code varchar(20) [not null]
  
  // Override values (if different from policy default)
  custom_value decimal(10,4)
  
  effective_date date [not null]
  end_date date
  
  decision_number varchar(100)
  is_current boolean [default: true]
  
  Note: '[E] Allowance assigned to employee'
}

// [AR] Payroll Period - Ky luong
Table compensation_payroll_period {
  id uuid [pk, default: `gen_random_uuid()`]
  
  period_year int [not null]
  period_month int [not null]
  period_start date [not null]
  period_end date [not null]
  
  status varchar(20) [default: 'open', note: 'open, calculating, review, approved, paid, closed']
  
  calculated_at timestamp
  calculated_by uuid
  approved_at timestamp
  approved_by uuid
  paid_at timestamp
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  indexes {
    (period_year, period_month) [unique]
  }
  
  Note: '[AR] Payroll period - aggregate root for monthly payroll'
}

// [E] Payslip - Phieu luong
Table compensation_payslip {
  id uuid [pk, default: `gen_random_uuid()`]
  payroll_period_id uuid [ref: > compensation_payroll_period.id, not null]
  employee_id uuid [not null]
  
  // Calculated values (denormalized for performance)
  base_salary_amount decimal(15,2) [note: 'Muc luong co so used']
  salary_coefficient decimal(4,2)
  gross_salary decimal(15,2)
  
  total_allowances decimal(15,2)
  overtime_pay decimal(15,2)
  teaching_overtime_pay decimal(15,2)
  bonus_amount decimal(15,2)
  
  // Deductions
  insurance_employee decimal(15,2)
  personal_income_tax decimal(15,2)
  other_deductions decimal(15,2)
  total_deductions decimal(15,2)
  
  net_salary decimal(15,2) [not null]
  
  // Employer costs
  insurance_employer decimal(15,2)
  
  // Metadata
  calculation_snapshot jsonb [note: 'Config values used for calculation']
  
  created_at timestamp [default: `now()`]
  
  indexes {
    (payroll_period_id, employee_id) [unique]
  }
  
  Note: '[E] Individual payslip within payroll period'
}

// [E] Payslip Item - Chi tiet phieu luong
Table compensation_payslip_item {
  id uuid [pk, default: `gen_random_uuid()`]
  payslip_id uuid [ref: > compensation_payslip.id, not null]
  
  item_type varchar(30) [not null, note: 'allowance, deduction, bonus, overtime']
  item_code varchar(50) [not null]
  item_name varchar(100) [not null]
  
  amount decimal(15,2) [not null]
  calculation_detail text
  
  Note: '[E] Line item detail in payslip'
}

// [AR] Advance Payment - Tam ung
Table compensation_advance {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  amount decimal(15,2) [not null]
  request_date date [not null]
  reason text
  
  status varchar(20) [default: 'pending', note: 'pending, approved, rejected, paid, deducted']
  
  approved_by uuid
  approved_at timestamp
  paid_at timestamp
  
  deducted_in_period_id uuid [ref: > compensation_payroll_period.id]
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Salary advance request'
}

// [AR] Bonus - Thuong
Table compensation_bonus {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  bonus_type varchar(30) [not null, note: 'tet, holiday, performance, achievement']
  amount decimal(15,2) [not null]
  bonus_date date [not null]
  reason text
  
  decision_number varchar(100)
  
  included_in_period_id uuid [ref: > compensation_payroll_period.id]
  
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Bonus payment'
}

// =============================================================================
// BOUNDED CONTEXT: TIME_MANAGEMENT (Supporting Domain)
// Attendance, leave, overtime
// =============================================================================

TableGroup time_management_context {
  time_attendance_record
  time_leave_request
  time_leave_balance
  time_overtime_request
  time_business_trip
}

// [AR] Attendance Record - Cham cong
Table time_attendance_record {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  attendance_date date [not null]
  
  check_in_time timestamp
  check_out_time timestamp
  check_in_method varchar(20) [note: 'fingerprint, card, face, manual']
  check_out_method varchar(20)
  
  work_hours decimal(4,2)
  overtime_hours decimal(4,2)
  
  status varchar(20) [note: 'present, absent, late, early_leave, on_leave, business_trip']
  note text
  
  version int [default: 1]
  
  indexes {
    (employee_id, attendance_date) [unique]
  }
  
  Note: '[AR] Daily attendance record'
}

// [AR] Leave Request - Don nghi phep
Table time_leave_request {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  leave_type_code varchar(20) [not null]
  start_date date [not null]
  end_date date [not null]
  total_days decimal(4,1) [not null]
  
  reason text
  supporting_document_id uuid [ref: > shared_document.id]
  
  status varchar(20) [default: 'pending', note: 'pending, approved, rejected, cancelled']
  
  // Approval workflow
  submitted_at timestamp [default: `now()`]
  reviewed_by uuid
  reviewed_at timestamp
  review_comment text
  
  version int [default: 1]
  
  Note: '[AR] Leave request with approval workflow'
}

// [E] Leave Balance - So du phep
Table time_leave_balance {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  leave_type_code varchar(20) [not null]
  year int [not null]
  
  entitled_days decimal(4,1) [not null]
  used_days decimal(4,1) [default: 0]
  carried_over_days decimal(4,1) [default: 0]
  pending_days decimal(4,1) [default: 0]
  remaining_days decimal(4,1)
  
  last_calculated_at timestamp
  
  indexes {
    (employee_id, leave_type_code, year) [unique]
  }
  
  Note: '[E] Leave balance tracking per year'
}

// [AR] Overtime Request - Don lam them gio
Table time_overtime_request {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  request_date date [not null]
  start_time timestamp [not null]
  end_time timestamp [not null]
  planned_hours decimal(4,2) [not null]
  actual_hours decimal(4,2)
  
  day_type varchar(20) [not null, note: 'weekday, weekend, holiday']
  reason text
  
  status varchar(20) [default: 'pending']
  approved_by uuid
  approved_at timestamp
  
  version int [default: 1]
  
  Note: '[AR] Overtime work request'
}

// [AR] Business Trip - Cong tac
Table time_business_trip {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  destination varchar(200) [not null]
  purpose text [not null]
  start_date date [not null]
  end_date date [not null]
  
  trip_type varchar(30) [note: 'domestic, international, conference, training']
  
  estimated_cost decimal(15,2)
  actual_cost decimal(15,2)
  
  status varchar(20) [default: 'pending']
  approved_by uuid
  approved_at timestamp
  
  version int [default: 1]
  
  Note: '[AR] Business trip record'
}

// =============================================================================
// BOUNDED CONTEXT: RECRUITMENT (Supporting Domain)
// Hiring process from posting to onboarding
// =============================================================================

TableGroup recruitment_context {
  recruit_job_posting
  recruit_candidate
  recruit_interview
  recruit_job_offer
}

// [AR] Job Posting - Thong bao tuyen dung
Table recruit_job_posting {
  id uuid [pk, default: `gen_random_uuid()`]
  
  title varchar(200) [not null]
  unit_id uuid [not null]
  position_code varchar(30)
  
  quantity int [default: 1]
  job_description text
  requirements text
  benefits text
  salary_range varchar(100)
  
  posting_date date [not null]
  closing_date date [not null]
  
  status varchar(20) [default: 'draft', note: 'draft, published, closed, filled, cancelled']
  
  created_by uuid
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Job posting aggregate'
}

// [AR] Candidate - Ung vien
Table recruit_candidate {
  id uuid [pk, default: `gen_random_uuid()`]
  job_posting_id uuid [ref: > recruit_job_posting.id, not null]
  
  // Personal info
  full_name varchar(100) [not null]
  email varchar(100) [not null]
  phone varchar(20)
  date_of_birth date
  gender varchar(10)
  
  // Application
  resume_document_id uuid [ref: > shared_document.id]
  cover_letter text
  
  // Background
  current_company varchar(200)
  current_position varchar(100)
  years_of_experience int
  highest_education varchar(50)
  major varchar(200)
  
  // Source tracking
  source varchar(50) [note: 'website, referral, job_board']
  referrer_employee_id uuid
  
  // Pipeline status
  status varchar(30) [default: 'applied', note: 'applied, screening, interviewing, offered, hired, rejected, withdrawn']
  
  applied_at timestamp [default: `now()`]
  
  version int [default: 1]
  
  Note: '[AR] Candidate in recruitment pipeline'
}

// [E] Interview - Phong van
Table recruit_interview {
  id uuid [pk, default: `gen_random_uuid()`]
  candidate_id uuid [ref: > recruit_candidate.id, not null]
  
  round_number int [default: 1]
  scheduled_time timestamp [not null]
  location varchar(200)
  interview_type varchar(30) [note: 'in_person, video, phone']
  
  interviewers uuid[] [note: 'Array of employee IDs']
  
  status varchar(20) [default: 'scheduled', note: 'scheduled, completed, cancelled, no_show']
  
  overall_score decimal(4,2)
  recommendation varchar(30) [note: 'strong_hire, hire, consider, no_hire']
  feedback text
  
  completed_at timestamp
  
  Note: '[E] Interview round within Candidate aggregate'
}

// [E] Job Offer - De xuat tuyen dung
Table recruit_job_offer {
  id uuid [pk, default: `gen_random_uuid()`]
  candidate_id uuid [ref: > recruit_candidate.id, not null]
  
  offer_date date [not null]
  expiry_date date [not null]
  
  position_title varchar(200) [not null]
  unit_id uuid [not null]
  
  proposed_salary_scale varchar(20)
  proposed_salary_grade int
  proposed_start_date date
  
  offer_letter_document_id uuid [ref: > shared_document.id]
  
  status varchar(20) [default: 'pending', note: 'pending, accepted, declined, expired, withdrawn']
  
  responded_at timestamp
  response_notes text
  
  // Link to created employee
  hired_employee_id uuid
  
  created_by uuid
  created_at timestamp [default: `now()`]
  
  Note: '[E] Job offer within Candidate aggregate'
}

// =============================================================================
// BOUNDED CONTEXT: PERFORMANCE (Supporting Domain)
// Evaluation, rewards, discipline
// =============================================================================

TableGroup performance_context {
  perf_evaluation_cycle
  perf_evaluation
  perf_evaluation_criterion
  perf_reward
  perf_discipline
  perf_emulation_title
}

// [AR] Evaluation Cycle - Ky danh gia
Table perf_evaluation_cycle {
  id uuid [pk, default: `gen_random_uuid()`]
  
  name varchar(100) [not null]
  year int [not null]
  start_date date [not null]
  end_date date [not null]
  self_evaluation_deadline date
  manager_evaluation_deadline date
  
  status varchar(20) [default: 'draft', note: 'draft, open, in_review, completed']
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Annual evaluation cycle'
}

// [E] Evaluation - Danh gia ca nhan
Table perf_evaluation {
  id uuid [pk, default: `gen_random_uuid()`]
  cycle_id uuid [ref: > perf_evaluation_cycle.id, not null]
  employee_id uuid [not null]
  
  // Self evaluation
  self_evaluation_completed boolean [default: false]
  self_evaluation_date timestamp
  self_evaluation_notes text
  
  // Manager evaluation
  evaluator_id uuid
  manager_evaluation_date timestamp
  manager_notes text
  
  // Scores
  teaching_score decimal(5,2) [note: 'For lecturers']
  research_score decimal(5,2) [note: 'For lecturers']
  service_score decimal(5,2)
  overall_score decimal(5,2)
  
  // Final rating
  final_rating varchar(30) [note: 'excellent, good, satisfactory, unsatisfactory']
  
  // Approvals
  unit_head_approved boolean [default: false]
  unit_head_approved_at timestamp
  hr_approved boolean [default: false]
  hr_approved_at timestamp
  
  status varchar(20) [default: 'pending']
  
  indexes {
    (cycle_id, employee_id) [unique]
  }
  
  Note: '[E] Individual evaluation within cycle'
}

// [E] Evaluation Criterion Score - Diem theo tieu chi
Table perf_evaluation_criterion {
  id uuid [pk, default: `gen_random_uuid()`]
  evaluation_id uuid [ref: > perf_evaluation.id, not null]
  
  criterion_name varchar(200) [not null]
  criterion_category varchar(50)
  weight decimal(5,2)
  
  self_score decimal(5,2)
  manager_score decimal(5,2)
  final_score decimal(5,2)
  
  comments text
  
  Note: '[E] Score for specific criterion'
}

// [AR] Reward - Khen thuong
Table perf_reward {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  reward_type varchar(50) [not null, note: 'certificate, commendation, medal, title']
  reward_level varchar(30) [note: 'department, university, ministry, state']
  reward_name varchar(200) [not null]
  
  award_date date [not null]
  award_year int [not null]
  
  decision_number varchar(100)
  decision_date date
  reason text
  
  cash_amount decimal(15,2)
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Reward/commendation record'
}

// [AR] Discipline - Ky luat
Table perf_discipline {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  discipline_type varchar(50) [not null, note: 'reprimand, warning, demotion, dismissal']
  severity_level int [note: '1=minor, 4=severe']
  
  violation_description text [not null]
  violation_date date
  
  discipline_date date [not null]
  decision_number varchar(100)
  decision_date date
  
  duration_months int [note: 'Duration of discipline period']
  end_date date
  
  salary_impact decimal(15,2) [note: 'Negative impact on salary']
  
  status varchar(20) [default: 'active', note: 'active, expired, revoked']
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Disciplinary action record'
}

// [AR] Emulation Title - Danh hieu thi dua
Table perf_emulation_title {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  
  title_type varchar(50) [not null, note: 'labor_hero, advanced_worker, emulation_fighter']
  title_level varchar(30) [note: 'unit, university, ministry, state']
  
  year int [not null]
  decision_number varchar(100)
  decision_date date
  
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Annual emulation title'
}

// =============================================================================
// BOUNDED CONTEXT: DEVELOPMENT (Supporting Domain)
// Training and career development
// =============================================================================

TableGroup development_context {
  dev_training_program
  dev_training_enrollment
  dev_training_certificate
}

// [AR] Training Program - Chuong trinh dao tao
Table dev_training_program {
  id uuid [pk, default: `gen_random_uuid()`]
  
  name varchar(200) [not null]
  description text
  
  training_type varchar(50) [not null, note: 'short_course, workshop, conference, degree_program']
  location_type varchar(20) [not null, note: 'domestic, international']
  
  provider_name varchar(200)
  provider_country varchar(100)
  
  start_date date
  end_date date
  duration_description varchar(100)
  
  budget decimal(15,2)
  
  status varchar(20) [default: 'planned']
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Training program'
}

// [E] Training Enrollment - Dang ky dao tao
Table dev_training_enrollment {
  id uuid [pk, default: `gen_random_uuid()`]
  training_program_id uuid [ref: > dev_training_program.id, not null]
  employee_id uuid [not null]
  
  enrollment_date date [not null]
  expected_completion date
  actual_completion date
  
  status varchar(20) [default: 'enrolled', note: 'enrolled, in_progress, completed, withdrawn']
  result varchar(50)
  
  // For degree programs
  degree_type varchar(30) [note: 'master, doctorate']
  thesis_title varchar(500)
  supervisor_name varchar(200)
  
  // Commitment tracking
  has_service_commitment boolean [default: false]
  commitment_years int
  commitment_end_date date
  
  // Cost tracking
  tuition_cost decimal(15,2)
  other_costs decimal(15,2)
  paid_by_university boolean [default: true]
  
  Note: '[E] Training enrollment within program'
}

// [E] Training Certificate - Chung chi dao tao
Table dev_training_certificate {
  id uuid [pk, default: `gen_random_uuid()`]
  enrollment_id uuid [ref: > dev_training_enrollment.id, not null]
  
  certificate_name varchar(200) [not null]
  certificate_type varchar(50)
  issue_date date
  certificate_number varchar(100)
  
  // Link to employee certificate if applicable
  synced_to_personnel boolean [default: false]
  
  Note: '[E] Certificate earned from training'
}

// =============================================================================
// BOUNDED CONTEXT: ACADEMIC (Supporting Domain - University Specific)
// Research and teaching load management
// =============================================================================

TableGroup academic_context {
  academic_research_project
  academic_research_member
  academic_publication
  academic_publication_author
  academic_thesis_supervision
  academic_year
  academic_semester
  academic_teaching_assignment
  academic_teaching_summary
}

// [AR] Research Project - De tai NCKH
Table academic_research_project {
  id uuid [pk, default: `gen_random_uuid()`]
  
  project_code varchar(50) [not null, unique]
  title varchar(500) [not null]
  
  project_level varchar(30) [not null, note: 'university, ministry, state, international']
  
  principal_investigator_id uuid [not null]
  unit_id uuid
  
  start_date date
  end_date date
  
  budget decimal(15,2)
  funding_source varchar(200)
  
  abstract text
  
  status varchar(20) [default: 'proposed', note: 'proposed, approved, in_progress, completed, cancelled']
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Research project aggregate'
}

// [E] Research Member - Thanh vien de tai
Table academic_research_member {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id uuid [ref: > academic_research_project.id, not null]
  employee_id uuid [not null]
  
  role varchar(30) [not null, note: 'pi, co_pi, researcher, assistant']
  join_date date
  leave_date date
  
  allocated_hours int [note: 'Gio quy doi']
  
  Note: '[E] Project member within research project'
}

// [AR] Publication - Cong bo khoa hoc
Table academic_publication {
  id uuid [pk, default: `gen_random_uuid()`]
  
  title varchar(500) [not null]
  publication_type varchar(30) [not null, note: 'journal_article, conference, book, patent']
  
  journal_name varchar(300)
  conference_name varchar(300)
  publisher varchar(200)
  
  publication_date date
  volume varchar(50)
  issue varchar(50)
  pages varchar(50)
  
  doi varchar(200)
  isbn varchar(50)
  issn varchar(50)
  
  is_isi boolean [default: false]
  is_scopus boolean [default: false]
  impact_factor decimal(6,3)
  
  abstract text
  keywords text
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Scientific publication aggregate'
}

// [E] Publication Author - Tac gia
Table academic_publication_author {
  id uuid [pk, default: `gen_random_uuid()`]
  publication_id uuid [ref: > academic_publication.id, not null]
  
  employee_id uuid [note: 'null if external author']
  author_name varchar(200) [not null]
  author_order int [not null]
  is_corresponding boolean [default: false]
  affiliation varchar(300)
  
  allocated_hours int [note: 'Gio quy doi']
  
  Note: '[E] Author within publication'
}

// [AR] Thesis Supervision - Huong dan luan van
Table academic_thesis_supervision {
  id uuid [pk, default: `gen_random_uuid()`]
  supervisor_id uuid [not null]
  
  student_name varchar(100) [not null]
  student_id varchar(50)
  
  thesis_type varchar(20) [not null, note: 'undergraduate, master, doctoral']
  thesis_title varchar(500) [not null]
  
  start_date date
  expected_end_date date
  defense_date date
  
  status varchar(20) [default: 'in_progress', note: 'in_progress, defended, graduated, withdrawn']
  result varchar(50)
  
  allocated_hours int
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Thesis supervision record'
}

// [AR] Academic Year - Nam hoc
Table academic_year {
  id uuid [pk, default: `gen_random_uuid()`]
  
  name varchar(50) [not null, unique, note: '2024-2025']
  start_date date [not null]
  end_date date [not null]
  is_current boolean [default: false]
  
  Note: '[AR] Academic year'
}

// [E] Semester - Hoc ky
Table academic_semester {
  id uuid [pk, default: `gen_random_uuid()`]
  academic_year_id uuid [ref: > academic_year.id, not null]
  
  semester_number int [not null, note: '1, 2, 3']
  name varchar(50)
  start_date date [not null]
  end_date date [not null]
  
  indexes {
    (academic_year_id, semester_number) [unique]
  }
  
  Note: '[E] Semester within academic year'
}

// [AR] Teaching Assignment - Phan cong giang day
Table academic_teaching_assignment {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  semester_id uuid [ref: > academic_semester.id, not null]
  
  course_code varchar(20) [not null]
  course_name varchar(200) [not null]
  class_code varchar(50)
  
  student_count int
  theory_hours int [default: 0]
  practice_hours int [default: 0]
  
  // Calculated standard hours
  standard_hours decimal(6,2)
  
  status varchar(20) [default: 'assigned']
  
  version int [default: 1]
  
  Note: '[AR] Teaching assignment for a course'
}

// [AR] Teaching Summary - Tong hop gio giang
Table academic_teaching_summary {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null]
  academic_year_id uuid [ref: > academic_year.id, not null]
  
  // Quota from config
  quota_hours int [not null]
  
  // Hours breakdown
  teaching_hours decimal(8,2) [default: 0]
  thesis_supervision_hours decimal(8,2) [default: 0]
  research_hours decimal(8,2) [default: 0]
  exam_grading_hours decimal(8,2) [default: 0]
  other_academic_hours decimal(8,2) [default: 0]
  
  // Totals
  total_standard_hours decimal(8,2)
  excess_hours decimal(8,2)
  
  // Payment linkage
  excess_payment_amount decimal(15,2)
  payment_processed boolean [default: false]
  
  last_calculated_at timestamp
  
  indexes {
    (employee_id, academic_year_id) [unique]
  }
  
  Note: '[AR] Annual teaching load summary'
}

// =============================================================================
// BOUNDED CONTEXT: IDENTITY (Generic Subdomain)
// Authentication and authorization
// =============================================================================

TableGroup identity_context {
  identity_user
  identity_role
  identity_permission
  identity_user_role
  identity_role_permission
  identity_session
}

// [AR] User - Tai khoan nguoi dung
Table identity_user {
  id uuid [pk, default: `gen_random_uuid()`]
  
  employee_id uuid [unique, note: 'Link to Personnel context']
  
  username varchar(50) [not null, unique]
  email varchar(100) [not null]
  password_hash varchar(255) [not null]
  
  is_active boolean [default: true]
  is_locked boolean [default: false]
  locked_until timestamp
  failed_login_attempts int [default: 0]
  
  last_login_at timestamp
  password_changed_at timestamp
  must_change_password boolean [default: false]
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] System user account'
}

// [AR] Role - Vai tro
Table identity_role {
  id uuid [pk, default: `gen_random_uuid()`]
  
  code varchar(50) [not null, unique]
  name varchar(100) [not null]
  description text
  
  is_system_role boolean [default: false, note: 'Cannot be deleted']
  is_active boolean [default: true]
  
  version int [default: 1]
  created_at timestamp [default: `now()`]
  
  Note: '[AR] Authorization role'
}

// [E] Permission - Quyen
Table identity_permission {
  id uuid [pk, default: `gen_random_uuid()`]
  
  code varchar(100) [not null, unique]
  name varchar(200) [not null]
  
  context varchar(50) [not null, note: 'Which bounded context']
  resource varchar(50) [not null]
  action varchar(30) [not null, note: 'create, read, update, delete, approve']
  
  Note: '[E] System permission'
}

// [E] User-Role Assignment
Table identity_user_role {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > identity_user.id, not null]
  role_id uuid [ref: > identity_role.id, not null]
  
  // Scope limitation
  scope_type varchar(30) [note: 'global, campus, unit']
  scope_id uuid [note: 'Campus or Unit ID if scoped']
  
  assigned_at timestamp [default: `now()`]
  assigned_by uuid
  
  indexes {
    (user_id, role_id, scope_type, scope_id) [unique]
  }
  
  Note: '[E] User-role assignment with scope'
}

// [E] Role-Permission
Table identity_role_permission {
  id uuid [pk, default: `gen_random_uuid()`]
  role_id uuid [ref: > identity_role.id, not null]
  permission_id uuid [ref: > identity_permission.id, not null]
  
  indexes {
    (role_id, permission_id) [unique]
  }
  
  Note: '[E] Role-permission mapping'
}

// [E] Session - Phien dang nhap
Table identity_session {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [ref: > identity_user.id, not null]
  
  token_hash varchar(255) [not null]
  ip_address varchar(50)
  user_agent text
  
  created_at timestamp [default: `now()`]
  expires_at timestamp [not null]
  revoked_at timestamp
  
  Note: '[E] User session'
}

// =============================================================================
// CONTEXT MAP - Cross-Context References
// These are maintained through IDs (not foreign keys) to preserve bounded context autonomy
// =============================================================================

// Note: In a true DDD implementation, cross-context references would be:
// 1. By ID only (no FK constraints across contexts)
// 2. Synchronized via domain events
// 3. Each context maintains its own view of shared data
//
// For pragmatic database design, we use UUIDs that can be validated at application level

// Context Integration Points:
// - Personnel.employee_id is referenced by: Employment, Compensation, Time, Performance, Academic
// - Organization.unit_id is referenced by: Employment, Recruitment, Academic
// - Configuration parameters are read by: Compensation, Time, Academic
// - Shared documents are used by: All contexts
